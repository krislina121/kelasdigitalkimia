<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelas Digital Kimia - Sistem Manajemen Pembelajaran</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap');
        
        body { font-family: 'Nunito', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #fefce8; }
        ::-webkit-scrollbar-thumb { background: #ca8a04; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a16207; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-yellow-50 text-slate-800 min-h-screen flex flex-col overflow-x-hidden">

    <!-- =========================
         LOGIN VIEW
    ========================== -->
    <section id="view-login" class="fixed inset-0 z-50 bg-gradient-to-br from-yellow-100 to-yellow-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex overflow-hidden slide-up border border-yellow-100 h-[600px]">
            
            <!-- Left Side: Illustration/Brand -->
            <div class="hidden md:flex w-1/2 bg-yellow-500 flex-col items-center justify-center p-12 text-white relative overflow-hidden">
                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="relative z-10 text-center">
                    <div class="inline-flex p-4 bg-white/20 rounded-full backdrop-blur-sm mb-6 border border-white/30">
                        <i data-lucide="flask-conical" class="w-16 h-16 text-white"></i>
                    </div>
                    <h1 class="text-4xl font-extrabold mb-2">Chemistry Lab</h1>
                    <p class="text-yellow-100 text-lg">Platform Pembelajaran Kimia Terintegrasi</p>
                </div>
                <div class="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-yellow-600/50 to-transparent"></div>
            </div>

            <!-- Right Side: Form -->
            <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center relative">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Selamat Datang</h2>
                    <p class="text-slate-500 mt-2">Silakan masuk menggunakan akun Anda.</p>
                </div>

                <form onsubmit="app.handlers.handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Username / ID</label>
                        <div class="relative group">
                            <i data-lucide="user" class="absolute left-3 top-3.5 w-5 h-5 text-slate-400 group-focus-within:text-yellow-500 transition-colors"></i>
                            <input type="text" id="login-user" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 outline-none transition-all" placeholder="Masukkan username" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Password</label>
                        <div class="relative group">
                            <i data-lucide="lock" class="absolute left-3 top-3.5 w-5 h-5 text-slate-400 group-focus-within:text-yellow-500 transition-colors"></i>
                            <input type="password" id="login-pass" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 outline-none transition-all" placeholder="Masukkan password" required>
                        </div>
                    </div>

                    <div id="login-alert" class="hidden p-3 rounded-lg bg-red-50 text-red-600 text-sm font-medium border border-red-100 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        <span>Username atau password salah!</span>
                    </div>

                    <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-yellow-500/30 transition-all transform hover:scale-[1.01] active:scale-[0.98]">
                        MASUK SEKARANG
                    </button>
                </form>

                <div class="mt-8 text-center text-xs text-slate-400 border-t pt-4">
                    <p>Demo Admin: <strong>admin</strong> / <strong>admin123</strong></p>
                    <p>Demo Siswa: <strong>siswa</strong> / <strong>siswa123</strong></p>
                </div>
            </div>
        </div>
    </section>

    <!-- =========================
         DASHBOARD VIEW
    ========================== -->
    <div id="view-dashboard" class="hidden flex-col min-h-screen">
        
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-yellow-200 sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto px-4 h-20 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-tr from-yellow-400 to-yellow-600 p-2.5 rounded-xl text-white shadow-lg shadow-yellow-500/30">
                        <i data-lucide="atom" class="w-6 h-6"></i>
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-bold text-slate-800 leading-tight">Kelas Kimia</h1>
                        <p class="text-xs text-yellow-600 font-semibold tracking-wider">PORTAL DIGITAL</p>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <div class="text-right hidden sm:block">
                        <p id="nav-user-name" class="font-bold text-slate-800 text-sm">User Name</p>
                        <span id="nav-user-role" class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700">Role</span>
                    </div>
                    <div class="relative cursor-pointer group" onclick="app.handlers.logout()">
                        <div class="h-10 w-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 border border-slate-200 group-hover:bg-red-50 group-hover:text-red-500 group-hover:border-red-200 transition-all">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </div>
                        <div class="absolute top-full right-0 mt-2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">Logout</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-grow container mx-auto px-4 py-8 flex flex-col md:flex-row gap-8">
            
            <!-- Sidebar Navigation -->
            <aside class="w-full md:w-64 flex-shrink-0">
                <nav class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sticky top-24">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2">Menu Utama</p>
                    <ul class="space-y-1" id="nav-menu">
                        <!-- Navigation items injected via JS -->
                    </ul>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-grow">
                
                <!-- Notification Toast -->
                <div id="toast-notification" class="hidden fixed top-24 right-4 z-50 bg-white shadow-xl rounded-lg border-l-4 p-4 min-w-[300px] slide-up">
                    <div class="flex items-center gap-3">
                        <div id="toast-icon" class="p-2 rounded-full"></div>
                        <div>
                            <h4 id="toast-title" class="font-bold text-sm"></h4>
                            <p id="toast-msg" class="text-xs text-slate-500"></p>
                        </div>
                    </div>
                </div>

                <!-- CONTENT SECTIONS -->
                
                <!-- 1. Profil -->
                <div id="page-profil" class="page-section fade-in">
                    <!-- Content injected by JS -->
                </div>

                <!-- 2. Jadwal -->
                <div id="page-jadwal" class="page-section hidden fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Jadwal Mengajar</h2>
                        <button onclick="app.ui.modals.openSchedule()" class="admin-only hidden bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-yellow-500/20 flex items-center gap-2 transition">
                            <i data-lucide="plus"></i> Tambah Jadwal
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-600 font-bold uppercase text-xs border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-4">Hari</th>
                                        <th class="px-6 py-4">Waktu</th>
                                        <th class="px-6 py-4">Mata Pelajaran</th>
                                        <th class="px-6 py-4">Kelas</th>
                                        <th class="px-6 py-4 text-center admin-only hidden">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-list" class="divide-y divide-slate-100">
                                    <!-- Populated by JS (Inline Edit Support) -->
                                </tbody>
                            </table>
                        </div>
                        <div id="schedule-empty" class="hidden py-12 text-center text-slate-400">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <p>Belum ada jadwal yang diatur.</p>
                        </div>
                    </div>
                </div>

                <!-- 3. Materi -->
                <div id="page-materi" class="page-section hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Bahan Ajar Kimia</h2>
                            <p class="text-slate-500 text-sm">Modul dan referensi pembelajaran per jenjang.</p>
                        </div>
                        <button onclick="app.ui.modals.openMaterial()" class="admin-only hidden bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-yellow-500/20 flex items-center gap-2 transition">
                            <i data-lucide="upload-cloud"></i> Upload Materi
                        </button>
                    </div>

                    <!-- Filter Section -->
                    <div class="flex flex-wrap gap-2 mb-8 overflow-x-auto pb-2" id="material-filters">
                        <button onclick="app.handlers.filterMaterials('all')" class="filter-btn px-5 py-2 rounded-full text-sm font-bold bg-yellow-500 text-white shadow-md shadow-yellow-500/30 transition-all transform hover:scale-105" data-filter="all">Semua</button>
                        <button onclick="app.handlers.filterMaterials('X')" class="filter-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-200 transition-all transform hover:scale-105" data-filter="X">Kelas X</button>
                        <button onclick="app.handlers.filterMaterials('XI')" class="filter-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-200 transition-all transform hover:scale-105" data-filter="XI">Kelas XI</button>
                        <button onclick="app.handlers.filterMaterials('XII')" class="filter-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-200 transition-all transform hover:scale-105" data-filter="XII">Kelas XII</button>
                    </div>

                    <div id="material-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Populated by JS -->
                    </div>
                    <div id="material-empty" class="hidden col-span-full py-12 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">
                        <i data-lucide="folder-open" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p>Belum ada bahan ajar tersedia untuk kategori ini.</p>
                    </div>
                </div>

                <!-- 4. Absensi -->
                <div id="page-absen" class="page-section hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Rekap Absensi</h2>
                            <p class="text-slate-500 text-sm">Monitoring kehadiran siswa.</p>
                        </div>
                        
                        <!-- Filter Controls -->
                        <div class="flex flex-wrap gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                            <input type="date" id="absen-date" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-yellow-400">
                            <select id="absen-jenjang" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-yellow-400">
                                <option value="X">Kelas X</option>
                                <option value="XI">Kelas XI</option>
                                <option value="XII">Kelas XII</option>
                            </select>
                            <select id="absen-kelas" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-yellow-400">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <button onclick="app.handlers.loadAttendance()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 min-h-[300px]">
                        <div class="admin-only hidden flex flex-wrap justify-end gap-3 mb-4 pb-4 border-b border-slate-50">
                            <div class="flex gap-2">
                                <button onclick="app.services.attendance.markAll('Hadir')" class="text-green-600 hover:bg-green-50 px-3 py-2 rounded-lg text-xs font-bold transition border border-transparent hover:border-green-100 flex items-center gap-1">
                                    <i data-lucide="check-square" class="w-3 h-3"></i> Tandai Semua Hadir
                                </button>
                            </div>
                            <div class="flex gap-2 border-l pl-3 border-slate-100">
                                <button onclick="app.handlers.resetSemester()" class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset Semester
                                </button>
                                <button onclick="app.handlers.exportAttendanceSemester()" class="bg-green-600 text-white hover:bg-green-700 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-md shadow-green-200">
                                    <i data-lucide="download" class="w-3 h-3"></i> Download Rekap Semester (.csv)
                                </button>
                            </div>
                        </div>

                        <div id="attendance-list" class="space-y-3"></div>
                        <div id="attendance-placeholder" class="text-center py-10 text-slate-400">
                            <i data-lucide="user-check" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
                            <p>Pilih filter tanggal dan kelas untuk menampilkan atau mengedit data harian.</p>
                        </div>
                    </div>
                </div>

                <!-- 5. Uji Kompetensi -->
                <div id="page-ujian" class="page-section hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Uji Kompetensi</h2>
                            <p class="text-slate-500 text-sm">Kuis Pilihan Ganda, Jawaban Singkat & Uraian.</p>
                        </div>
                        <button onclick="app.ui.modals.openQuizCreate()" class="admin-only hidden bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-yellow-500/20 flex items-center gap-2 transition">
                            <i data-lucide="plus-circle"></i> Buat Kuis Baru
                        </button>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-8 overflow-x-auto pb-2" id="quiz-filters">
                        <button onclick="app.handlers.filterQuizzes('all')" class="quiz-filter-btn px-5 py-2 rounded-full text-sm font-bold bg-yellow-500 text-white shadow-md shadow-yellow-500/30 transition-all transform hover:scale-105" data-filter="all">Semua</button>
                        <button onclick="app.handlers.filterQuizzes('X')" class="quiz-filter-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-200 transition-all transform hover:scale-105" data-filter="X">Kelas X</button>
                        <button onclick="app.handlers.filterQuizzes('XI')" class="quiz-filter-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-200 transition-all transform hover:scale-105" data-filter="XI">Kelas XI</button>
                        <button onclick="app.handlers.filterQuizzes('XII')" class="quiz-filter-btn px-5 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-200 transition-all transform hover:scale-105" data-filter="XII">Kelas XII</button>
                    </div>

                    <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Populated by JS -->
                    </div>
                    <div id="quiz-empty" class="hidden col-span-full py-12 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p>Belum ada kuis tersedia untuk kategori ini.</p>
                    </div>
                </div>

                <!-- 6. Data Siswa -->
                <div id="page-datasiswa" class="page-section hidden fade-in">
                    <div class="mb-6 border-b border-slate-100 pb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Manajemen Siswa</h2>
                        <p class="text-slate-500 text-sm">Import dan kelola akun siswa.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-yellow-50 rounded-2xl p-6 border border-yellow-100 h-fit">
                            <h3 class="font-bold text-yellow-800 mb-4 flex items-center gap-2">
                                <i data-lucide="user-plus" class="w-5 h-5"></i> Import Siswa
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-yellow-700 uppercase">Jenjang & Kelas</label>
                                    <div class="flex gap-2 mt-1">
                                        <select id="import-jenjang" class="w-1/2 p-2 rounded-lg border-yellow-200 text-sm"><option value="X">X</option><option value="XI">XI</option><option value="XII">XII</option></select>
                                        <select id="import-angka" class="w-1/2 p-2 rounded-lg border-yellow-200 text-sm"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-yellow-700 uppercase">Daftar Nama</label>
                                    <textarea id="import-names" rows="6" class="w-full mt-1 p-3 rounded-lg border-yellow-200 text-sm focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Salin nama siswa di sini (satu per baris)..."></textarea>
                                </div>
                                <button onclick="app.handlers.handleImport()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 rounded-lg shadow-md transition">
                                    Proses Import
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-4 border-b border-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-700">Database Siswa</h3>
                                <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-full" id="student-count">0 Siswa</span>
                            </div>
                            <div class="max-h-[500px] overflow-y-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-500 font-bold sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3">Nama</th>
                                            <th class="px-4 py-3">Kelas</th>
                                            <th class="px-4 py-3">Username</th>
                                            <th class="px-4 py-3">Password</th>
                                        </tr>
                                    </thead>
                                    <tbody id="student-db-list" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- =========================
         MODALS (POPUPS)
    ========================== -->
    
    <!-- Modal: Edit Profile (NEW) -->
    <div id="modal-edit-profile" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 slide-up max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Edit Profil Guru</h3>
            <form onsubmit="app.handlers.saveProfile(event)" class="space-y-4">
                
                <!-- Photo Upload -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Foto Profil</label>
                    <div class="flex items-center gap-4">
                        <div id="preview-avatar" class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 overflow-hidden">
                            <i data-lucide="user" class="w-8 h-8 text-slate-300"></i>
                        </div>
                        <input type="file" name="photo" id="edit-photo" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 transition" onchange="app.handlers.previewImage(this)">
                    </div>
                </div>

                <!-- Basic Info -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Nama Lengkap & Gelar</label>
                    <input type="text" name="name" id="edit-name" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Bio / Tentang Saya</label>
                    <textarea name="bio" id="edit-bio" rows="3" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required></textarea>
                </div>

                <!-- Contact -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Email</label>
                        <input type="email" name="email" id="edit-email" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Telepon / WA</label>
                        <input type="text" name="phone" id="edit-phone" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                    </div>
                </div>

                <!-- Professional -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Pendidikan Terakhir</label>
                    <input type="text" name="edu" id="edit-edu" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Mata Pelajaran</label>
                    <input type="text" name="mapel" id="edit-mapel" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 mt-4">
                    <button type="button" onclick="app.ui.modals.closeAll()" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Add Schedule -->
    <div id="modal-schedule" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 slide-up">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Tambah Jadwal</h3>
            <form onsubmit="app.handlers.saveSchedule(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <select name="day" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                    </select>
                    <input type="text" name="time" placeholder="Jam (08:00 - 10:00)" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                </div>
                <input type="text" name="subject" placeholder="Materi / Kegiatan" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                <div class="grid grid-cols-2 gap-4">
                    <select name="jenjang" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm"><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select>
                    <select name="kelas" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="app.ui.modals.closeAll()" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Add Material -->
    <div id="modal-material" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 slide-up">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Tambah Bahan Ajar</h3>
            <form onsubmit="app.handlers.saveMaterial(event)" class="space-y-4">
                <input type="text" name="title" placeholder="Judul Materi" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                <textarea name="desc" placeholder="Deskripsi singkat..." rows="3" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <select name="type" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                        <option value="pdf">Dokumen (PDF)</option>
                        <option value="video">Video</option>
                        <option value="link">Link Eksternal</option>
                    </select>
                    <select name="jenjang" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                        <option value="X">Kelas X</option>
                        <option value="XI">Kelas XI</option>
                        <option value="XII">Kelas XII</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="app.ui.modals.closeAll()" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Create Quiz Step 1 (Setup) -->
    <div id="modal-quiz-create" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 slide-up">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Buat Kuis Baru (Tahap 1)</h3>
            <p class="text-slate-500 text-sm mb-4">Tentukan detail dasar kuis.</p>
            <form onsubmit="app.handlers.setupQuizForm(event)" class="space-y-4">
                <input type="text" id="new-quiz-title" name="title" placeholder="Judul Kuis / Topik" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                <div class="grid grid-cols-2 gap-4">
                    <select id="new-quiz-type" name="type" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm font-semibold text-slate-700">
                        <option value="pg">Pilihan Ganda</option>
                        <option value="short">Jawaban Singkat</option>
                        <option value="essay">Uraian / Jawaban Panjang</option>
                    </select>
                    <input type="number" id="new-quiz-count" name="count" placeholder="Jumlah Soal" min="1" max="50" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm" required>
                </div>
                <select name="jenjang" id="new-quiz-jenjang" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm">
                    <option value="X">Kelas X</option>
                    <option value="XI">Kelas XI</option>
                    <option value="XII">Kelas XII</option>
                </select>
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <p class="text-xs text-yellow-800">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        <b>Pilihan Ganda</b>: 5 Opsi (A-E).<br>
                        <b>Jawaban Singkat</b>: Input Teks Pendek.<br>
                        <b>Uraian</b>: Textarea & Upload File (Foto/PDF).
                    </p>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="app.ui.modals.closeAll()" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm font-bold">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600">Lanjut ke Soal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Create Quiz Step 2 (Questions Input) -->
    <div id="modal-quiz-questions" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 slide-up flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Input Soal Kuis</h3>
                    <p class="text-slate-500 text-sm" id="quiz-question-subtitle">Mengisi detail soal</p>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold" id="quiz-question-hint">Pilih radio button untuk KUNCI JAWABAN</span>
                    <button onclick="app.ui.modals.closeAll()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            
            <form onsubmit="app.handlers.saveFullQuiz(event)" class="flex flex-col flex-grow overflow-hidden">
                <div id="questions-container" class="flex-grow overflow-y-auto pr-2 space-y-6">
                    <!-- Dynamic Question Forms generated here -->
                </div>
                
                <div class="pt-4 border-t border-slate-100 flex justify-between items-center mt-4">
                    <div class="text-sm font-bold text-slate-600">Total Skor: <span id="total-score-calc" class="text-yellow-600">0</span></div>
                    <div class="flex gap-3">
                        <button type="button" onclick="document.getElementById('modal-quiz-questions').classList.add('hidden'); document.getElementById('modal-quiz-create').classList.remove('hidden');" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg text-sm font-bold">Kembali</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 shadow-lg shadow-green-200">Simpan & Terbitkan</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Take Quiz (Simulation) -->
    <div id="modal-quiz-run" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 slide-up relative max-h-[90vh] overflow-y-auto">
            <button onclick="app.ui.modals.closeAll()" class="absolute top-4 right-4 text-slate-300 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="text-center mb-8 border-b border-slate-100 pb-6">
                <span id="run-quiz-type-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 mb-3 inline-block">Tipe Kuis</span>
                <h2 id="run-quiz-title" class="text-2xl font-bold text-slate-800">Judul Kuis</h2>
                <div class="flex justify-center gap-4 mt-2 text-sm text-slate-500">
                    <span id="run-quiz-count">0 Soal</span>
                    <span>|</span>
                    <span id="run-quiz-score">Total Skor: 0</span>
                </div>
            </div>

            <form id="run-quiz-form" onsubmit="return false;">
                <div id="run-quiz-content" class="space-y-8">
                    <!-- Questions injected here -->
                </div>

                <div class="flex justify-end mt-8 pt-6 border-t border-slate-100">
                    <button type="button" id="btn-submit-quiz" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 transition transform hover:scale-105">
                        Kirim Jawaban
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- =========================
         APPLICATION LOGIC
    ========================== -->
    <script>
        /**
         * APP ARCHITECTURE
         * 1. Services: Handle Data Logic (LocalStorage)
         * 2. State: Handle Session & View State
         * 3. UI: Handle DOM Manipulation
         * 4. Handlers: Handle Events
         */

        const app = {
            // --- DATA SERVICES ---
            services: {
                storage: {
                    get: (key, def) => JSON.parse(localStorage.getItem(key)) || def,
                    set: (key, val) => {
                        try {
                            localStorage.setItem(key, JSON.stringify(val));
                        } catch (e) {
                            console.error("Storage failed:", e);
                            if (e.name === 'QuotaExceededError') {
                                alert("Penyimpanan penuh! Gambar terlalu besar atau terlalu banyak data. Coba gunakan gambar yang lebih kecil.");
                            }
                        }
                    }
                },
                
                students: {
                    getAll: () => app.services.storage.get('db_students', []),
                    addBatch: (newStudents) => {
                        const current = app.services.students.getAll();
                        const updated = [...current, ...newStudents];
                        app.services.storage.set('db_students', updated);
                        return updated;
                    },
                    auth: (user, pass) => {
                        const students = app.services.students.getAll();
                        return students.find(s => s.username === user && s.password === pass);
                    }
                },

                schedule: {
                    getAll: () => app.services.storage.get('db_schedule', [
                        { id: 1, day: 'Senin', time: '07:00 - 09:00', subject: 'Kimia Dasar', jenjang: 'X', kelas: '1' },
                        { id: 2, day: 'Senin', time: '09:30 - 11:30', subject: 'Kimia Organik', jenjang: 'XI', kelas: '2' },
                        { id: 3, day: 'Selasa', time: '08:00 - 10:00', subject: 'Praktikum Larutan', jenjang: 'XII', kelas: '1' },
                        { id: 4, day: 'Rabu', time: '10:00 - 12:00', subject: 'Kimia Unsur', jenjang: 'XII', kelas: '3' },
                        { id: 5, day: 'Kamis', time: '13:00 - 15:00', subject: 'Kimia Analisis', jenjang: 'XI', kelas: '1' }
                    ]),
                    add: (item) => {
                        const data = app.services.schedule.getAll();
                        data.push({ ...item, id: Date.now() });
                        app.services.storage.set('db_schedule', data);
                    },
                    update: (id, updatedItem) => {
                        let data = app.services.schedule.getAll();
                        data = data.map(item => item.id === id ? { ...item, ...updatedItem } : item);
                        app.services.storage.set('db_schedule', data);
                    },
                    delete: (id) => {
                        const data = app.services.schedule.getAll().filter(i => i.id !== id);
                        app.services.storage.set('db_schedule', data);
                    }
                },

                materials: {
                    getAll: () => app.services.storage.get('db_materials', [
                        { id: 1, title: 'Modul: Struktur Atom', desc: 'Pengenalan teori atom Dalton hingga Mekanika Kuantum.', type: 'pdf', jenjang: 'X', date: '2024-01-10' },
                        { id: 2, title: 'PPT: Ikatan Kimia', desc: 'Ikatan Ion, Kovalen, dan Logam serta sifat fisikanya.', type: 'pdf', jenjang: 'X', date: '2024-01-12' },
                        { id: 3, title: 'Video: Hidrokarbon', desc: 'Visualisasi struktur Alkana, Alkena, dan Alkuna.', type: 'video', jenjang: 'XI', date: '2024-02-15' },
                        { id: 4, title: 'Modul: Laju Reaksi', desc: 'Faktor-faktor yang mempengaruhi laju reaksi kimia.', type: 'pdf', jenjang: 'XI', date: '2024-02-20' },
                        { id: 5, title: 'Video: Sifat Koligatif', desc: 'Penerapan sifat koligatif larutan dalam kehidupan.', type: 'video', jenjang: 'XII', date: '2024-03-01' },
                        { id: 6, title: 'Simulasi Redoks', desc: 'Link simulasi interaktif penyetaraan reaksi redoks.', type: 'link', jenjang: 'XII', date: '2024-03-10' }
                    ]),
                    add: (item) => {
                        const data = app.services.materials.getAll();
                        data.push({ ...item, id: Date.now(), date: new Date().toISOString().split('T')[0] });
                        app.services.storage.set('db_materials', data);
                    },
                    delete: (id) => {
                        const data = app.services.materials.getAll().filter(i => i.id !== id);
                        app.services.storage.set('db_materials', data);
                    }
                },

                quizzes: {
                    getAll: () => app.services.storage.get('db_quizzes', []),
                    add: (item) => {
                        const data = app.services.quizzes.getAll();
                        data.push({ ...item, id: Date.now(), count: item.questions.length, results: [] });
                        app.services.storage.set('db_quizzes', data);
                    },
                    delete: (id) => {
                        const data = app.services.quizzes.getAll().filter(i => i.id !== id);
                        app.services.storage.set('db_quizzes', data);
                    },
                    saveResult: (quizId, result) => {
                        let data = app.services.quizzes.getAll();
                        const quizIndex = data.findIndex(q => q.id === quizId);
                        if (quizIndex > -1) {
                            if (!data[quizIndex].results) data[quizIndex].results = [];
                            data[quizIndex].results.push(result);
                            app.services.storage.set('db_quizzes', data);
                        }
                    }
                },

                attendance: {
                    getKey: (date, jenjang, kelas) => `absensi_${date}_${jenjang}_${kelas}`,
                    get: (date, jenjang, kelas) => app.services.storage.get(`absensi_${date}_${jenjang}_${kelas}`, {}),
                    save: (date, jenjang, kelas, data) => app.services.storage.set(`absensi_${date}_${jenjang}_${kelas}`, data),
                    getDates: (jenjang, kelas) => {
                        const dates = [];
                        const pattern = new RegExp(`^absensi_(.*)_${jenjang}_${kelas}$`);
                        for(let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            const match = key.match(pattern);
                            if(match) {
                                dates.push(match[1]);
                            }
                        }
                        return dates.sort();
                    },
                    reset: (jenjang, kelas) => {
                         const pattern = new RegExp(`^absensi_(.*)_${jenjang}_${kelas}$`);
                         const keysToRemove = [];
                         for(let i = 0; i < localStorage.length; i++) {
                             const key = localStorage.key(i);
                             if(pattern.test(key)) {
                                 keysToRemove.push(key);
                             }
                         }
                         keysToRemove.forEach(k => localStorage.removeItem(k));
                         return keysToRemove.length;
                    },
                    markAll: (status) => {
                        const date = document.getElementById('absen-date').value;
                        const jenjang = document.getElementById('absen-jenjang').value;
                        const kelas = document.getElementById('absen-kelas').value;
                        
                        if(!date) return app.ui.toast("Pilih tanggal dulu!", "error");

                        const students = app.services.students.getAll().filter(s => s.jenjang === jenjang && s.angka === kelas);
                        const record = {};
                        students.forEach(s => record[s.id] = status);
                        
                        app.services.attendance.save(date, jenjang, kelas, record);
                        app.handlers.loadAttendance(); // Refresh UI
                        app.ui.toast("Semua siswa ditandai hadir.", "success");
                    }
                }
            },

            // --- UI RENDERERS ---
            ui: {
                toast: (msg, type = "info") => {
                    const el = document.getElementById('toast-notification');
                    const title = document.getElementById('toast-title');
                    const message = document.getElementById('toast-msg');
                    const icon = document.getElementById('toast-icon');

                    el.classList.remove('hidden');
                    title.textContent = type === 'success' ? 'Berhasil' : type === 'error' ? 'Gagal' : 'Info';
                    message.textContent = msg;

                    if(type === 'success') {
                        icon.innerHTML = '<i data-lucide="check" class="text-green-600"></i>';
                        icon.className = 'bg-green-100 p-2 rounded-full';
                        el.className = 'fixed top-24 right-4 z-50 bg-white shadow-xl rounded-lg border-l-4 border-green-500 p-4 min-w-[300px] slide-up';
                    } else if (type === 'error') {
                        icon.innerHTML = '<i data-lucide="alert-triangle" class="text-red-600"></i>';
                        icon.className = 'bg-red-100 p-2 rounded-full';
                        el.className = 'fixed top-24 right-4 z-50 bg-white shadow-xl rounded-lg border-l-4 border-red-500 p-4 min-w-[300px] slide-up';
                    }
                    lucide.createIcons();
                    setTimeout(() => el.classList.add('hidden'), 3000);
                },

                modals: {
                    closeAll: () => document.querySelectorAll('.fixed.z-50.modal-backdrop').forEach(el => el.classList.add('hidden')),
                    openSchedule: () => document.getElementById('modal-schedule').classList.remove('hidden'),
                    openMaterial: () => document.getElementById('modal-material').classList.remove('hidden'),
                    openEditProfile: () => document.getElementById('modal-edit-profile').classList.remove('hidden'),
                    openQuizCreate: () => {
                        document.getElementById('modal-quiz-create').classList.remove('hidden');
                        document.getElementById('modal-quiz-questions').classList.add('hidden');
                    },
                    openQuizRun: (quiz) => {
                        const modal = document.getElementById('modal-quiz-run');
                        const content = document.getElementById('run-quiz-content');
                        const btnSubmit = document.getElementById('btn-submit-quiz');
                        
                        document.getElementById('run-quiz-title').textContent = quiz.title;
                        document.getElementById('run-quiz-count').textContent = quiz.questions.length + " Soal";
                        document.getElementById('run-quiz-score').textContent = "Total Bobot: " + quiz.totalScore;
                        document.getElementById('run-quiz-type-badge').textContent = quiz.type === 'pg' ? 'Pilihan Ganda' : quiz.type === 'short' ? 'Jawaban Singkat' : 'Uraian';
                        
                        // Set submit handler with closure to access quiz ID
                        btnSubmit.onclick = () => app.handlers.submitQuiz(quiz.id);

                        content.innerHTML = quiz.questions.map((q, i) => {
                            if (quiz.type === 'pg') {
                                return `
                                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                    <div class="flex justify-between mb-4">
                                        <span class="font-bold text-slate-800 text-lg">Soal No. ${i+1}</span>
                                        <span class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Bobot: ${q.score}</span>
                                    </div>
                                    <p class="text-slate-700 text-base mb-6 font-medium leading-relaxed whitespace-pre-wrap">${q.text}</p>
                                    <div class="space-y-3">
                                        ${q.options.map((opt, idx) => `
                                            <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg bg-white hover:bg-yellow-50 cursor-pointer transition">
                                                <input type="radio" name="q_${i}" value="${idx}" class="w-5 h-5 text-yellow-500 focus:ring-yellow-500 border-slate-300">
                                                <span class="text-sm text-slate-700 font-medium"><span class="font-bold text-slate-400 mr-2">${String.fromCharCode(65+idx)}.</span> ${opt}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                `;
                            } else if (quiz.type === 'short') {
                                return `
                                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                    <div class="flex justify-between mb-4">
                                        <span class="font-bold text-slate-800 text-lg">Soal No. ${i+1}</span>
                                        <span class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Bobot: ${q.score}</span>
                                    </div>
                                    <p class="text-slate-700 text-base mb-6 font-medium leading-relaxed whitespace-pre-wrap">${q.text}</p>
                                    <div>
                                        <input type="text" name="q_${i}" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Ketik jawaban singkat Anda di sini...">
                                    </div>
                                </div>
                                `;
                            } else {
                                // Essay with file upload
                                return `
                                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                    <div class="flex justify-between mb-4">
                                        <span class="font-bold text-slate-800 text-lg">Soal No. ${i+1}</span>
                                        <span class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Bobot: ${q.score}</span>
                                    </div>
                                    <p class="text-slate-700 text-base mb-6 font-medium leading-relaxed whitespace-pre-wrap">${q.text}</p>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Jawaban Teks</label>
                                            <textarea name="q_${i}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Ketik uraian jawaban Anda di sini..."></textarea>
                                        </div>
                                        <div class="border-t border-slate-200 pt-3">
                                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Upload File Jawaban (Opsional)</label>
                                            <input type="file" name="q_file_${i}" accept="image/*,.pdf,.doc,.docx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 transition"/>
                                            <p class="text-[10px] text-slate-400 mt-1">Format: Foto, PDF, atau DOCX.</p>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }
                        }).join('');
                        
                        modal.classList.remove('hidden');
                    }
                },

                renderMenu: (role) => {
                    const menu = document.getElementById('nav-menu');
                    const items = [
                        { id: 'profil', label: 'Profil Saya', icon: 'user', roles: ['admin', 'student'] },
                        { id: 'jadwal', label: 'Jadwal Mengajar', icon: 'calendar', roles: ['admin', 'student'] },
                        { id: 'materi', label: 'Bahan Ajar', icon: 'book-open', roles: ['admin', 'student'] },
                        { id: 'ujian', label: 'Uji Kompetensi', icon: 'clipboard-list', roles: ['admin', 'student'] },
                        { id: 'absen', label: 'Absensi', icon: 'check-square', roles: ['admin', 'student'] }, // Student view readonly
                        { id: 'datasiswa', label: 'Data Siswa', icon: 'users', roles: ['admin'] }
                    ];

                    menu.innerHTML = items
                        .filter(i => i.roles.includes(role))
                        .map(i => `
                        <li>
                            <button onclick="app.handlers.nav('${i.id}')" id="btn-${i.id}" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-yellow-50 hover:text-yellow-700 transition-all font-medium text-sm">
                                <i data-lucide="${i.icon}" class="w-5 h-5"></i>
                                ${i.label}
                            </button>
                        </li>
                    `).join('');
                    lucide.createIcons();
                },

                renderProfile: (user) => {
                    const container = document.getElementById('page-profil');
                    
                    if (user.role === 'admin') {
                        // Calculate Experience dynamically
                        const currentYear = new Date().getFullYear();
                        const startYear = 2009;
                        const expYears = currentYear - startYear + " Tahun";

                        // Check if custom data exists in storage
                        const storedUser = app.services.storage.get('admin_profile', null);
                        const displayUser = storedUser ? { ...user, ...storedUser, exp: expYears } : { ...user, exp: expYears };

                        // Avatar Logic
                        let avatarHtml = '';
                        if (displayUser.photo) {
                            avatarHtml = `<img src="${displayUser.photo}" class="w-full h-full object-cover">`;
                        } else {
                            avatarHtml = `<span class="text-2xl font-bold text-white">${displayUser.name.charAt(0)}</span>`;
                        }

                        container.innerHTML = `
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-3xl p-8 text-white shadow-xl shadow-yellow-500/20 mb-8 relative overflow-hidden">
                            <i data-lucide="flask-conical" class="absolute -right-6 -bottom-6 w-48 h-48 text-white opacity-10 rotate-12"></i>
                            
                            <div class="relative z-10 flex flex-col md:flex-row items-center gap-6">
                                <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border-2 border-white/50 overflow-hidden relative">
                                    ${avatarHtml}
                                </div>
                                <div class="text-center md:text-left flex-grow">
                                    <div class="flex items-center justify-center md:justify-start gap-3">
                                        <h2 class="text-3xl font-bold">${displayUser.name}</h2>
                                        <button onclick="app.handlers.openEditProfile()" class="bg-white/20 hover:bg-white/30 p-1.5 rounded-lg backdrop-blur-sm transition" title="Edit Profil">
                                            <i data-lucide="edit-3" class="w-4 h-4 text-white"></i>
                                        </button>
                                    </div>
                                    <p class="text-yellow-100 mt-1 text-lg">${displayUser.desc}</p>
                                    <div class="mt-4 flex flex-wrap justify-center md:justify-start gap-3">
                                        <span class="px-3 py-1 bg-white/20 rounded-lg text-xs font-medium backdrop-blur-md border border-white/10 flex items-center gap-1">
                                            <i data-lucide="check-circle" class="w-3 h-3"></i> Guru Aktif
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1 space-y-6">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <i data-lucide="user" class="w-5 h-5 text-yellow-500"></i> Tentang Saya
                                    </h3>
                                    <p class="text-slate-600 text-sm leading-relaxed">${displayUser.bio}</p>
                                </div>
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <i data-lucide="phone" class="w-5 h-5 text-yellow-500"></i> Kontak
                                    </h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center gap-3">
                                            <div class="bg-yellow-50 p-2 rounded-lg text-yellow-600">
                                                <i data-lucide="mail" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-400 font-bold uppercase">Email</p>
                                                <p class="text-sm font-medium text-slate-700 break-all">${displayUser.email}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="bg-yellow-50 p-2 rounded-lg text-yellow-600">
                                                <i data-lucide="smartphone" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-400 font-bold uppercase">Telepon / WA</p>
                                                <p class="text-sm font-medium text-slate-700">${displayUser.phone}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-2 space-y-6">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full">
                                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                                        <i data-lucide="briefcase" class="w-5 h-5 text-yellow-500"></i> Informasi Profesional
                                    </h3>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                        <div class="p-4 rounded-xl bg-slate-50 border border-slate-100">
                                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Pendidikan Terakhir</p>
                                            <p class="font-bold text-slate-800 text-lg">${displayUser.edu}</p>
                                        </div>
                                        <div class="p-4 rounded-xl bg-slate-50 border border-slate-100">
                                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Pengalaman Mengajar</p>
                                            <p class="font-bold text-slate-800 text-lg">${displayUser.exp}</p>
                                        </div>
                                        <div class="p-4 rounded-xl bg-slate-50 border border-slate-100">
                                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Mata Pelajaran</p>
                                            <p class="font-bold text-slate-800 text-lg">${displayUser.mapel}</p>
                                        </div>
                                        <div class="p-4 rounded-xl bg-slate-50 border border-slate-100">
                                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Status Kepegawaian</p>
                                            <p class="font-bold text-slate-800 text-lg">Guru Tetap</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    } else {
                        container.innerHTML = `
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-3xl p-8 text-white shadow-xl shadow-yellow-500/20 mb-8 relative overflow-hidden">
                            <i data-lucide="flask-conical" class="absolute -right-6 -bottom-6 w-48 h-48 text-white opacity-10 rotate-12"></i>
                            <div class="relative z-10 flex flex-col md:flex-row items-center gap-6">
                                <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border-2 border-white/50 text-2xl font-bold">
                                    ${user.name.charAt(0)}
                                </div>
                                <div class="text-center md:text-left">
                                    <h2 class="text-3xl font-bold">${user.name}</h2>
                                    <p class="text-yellow-100 mt-1">${user.desc}</p>
                                    <div class="mt-4 flex flex-wrap justify-center md:justify-start gap-3">
                                        <span class="px-3 py-1 bg-white/20 rounded-lg text-xs font-medium backdrop-blur-md border border-white/10">Siswa Aktif</span>
                                        <span class="px-3 py-1 bg-white/20 rounded-lg text-xs font-medium backdrop-blur-md border border-white/10">Semester Ganjil</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="info" class="w-5 h-5 text-yellow-500"></i> Informasi Akademik</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between border-b border-slate-50 pb-2">
                                        <span class="text-slate-500">Tahun Ajaran</span>
                                        <span class="font-medium text-slate-800">2024/2025</span>
                                    </div>
                                    <div class="flex justify-between border-b border-slate-50 pb-2">
                                        <span class="text-slate-500">Jenjang</span>
                                        <span class="font-medium text-slate-800">SMA/SMK</span>
                                    </div>
                                    <div class="flex justify-between pb-2">
                                        <span class="text-slate-500">Status</span>
                                        <span class="text-green-600 font-bold bg-green-50 px-2 rounded text-xs py-0.5">Terdaftar</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }
                    lucide.createIcons();
                },

                renderSchedule: () => {
                    const list = app.services.schedule.getAll();
                    const tbody = document.getElementById('schedule-list');
                    const empty = document.getElementById('schedule-empty');
                    const isAdmin = app.state.user.role === 'admin';
                    const editingId = app.state.editingId;

                    if(list.length === 0) {
                        tbody.innerHTML = '';
                        empty.classList.remove('hidden');
                        return;
                    }

                    empty.classList.add('hidden');
                    const dayOrder = { 'Senin': 1, 'Selasa': 2, 'Rabu': 3, 'Kamis': 4, 'Jumat': 5 };
                    list.sort((a,b) => (dayOrder[a.day] || 9) - (dayOrder[b.day] || 9));

                    tbody.innerHTML = list.map(item => {
                        const isEditing = item.id === editingId;
                        if (isEditing) {
                            return `
                            <tr class="bg-yellow-50 border-b border-yellow-100">
                                <td class="px-6 py-4">
                                    <select id="edit-day-${item.id}" class="w-full p-2 bg-white border border-yellow-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-yellow-500">
                                        <option value="Senin" ${item.day === 'Senin' ? 'selected' : ''}>Senin</option>
                                        <option value="Selasa" ${item.day === 'Selasa' ? 'selected' : ''}>Selasa</option>
                                        <option value="Rabu" ${item.day === 'Rabu' ? 'selected' : ''}>Rabu</option>
                                        <option value="Kamis" ${item.day === 'Kamis' ? 'selected' : ''}>Kamis</option>
                                        <option value="Jumat" ${item.day === 'Jumat' ? 'selected' : ''}>Jumat</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4"><input type="text" id="edit-time-${item.id}" value="${item.time}" class="w-full p-2 bg-white border border-yellow-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-yellow-500"></td>
                                <td class="px-6 py-4"><input type="text" id="edit-subject-${item.id}" value="${item.subject}" class="w-full p-2 bg-white border border-yellow-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-yellow-500"></td>
                                <td class="px-6 py-4">
                                    <div class="flex gap-2">
                                        <select id="edit-jenjang-${item.id}" class="w-20 p-2 bg-white border border-yellow-300 rounded text-sm"><option value="X" ${item.jenjang === 'X' ? 'selected' : ''}>X</option><option value="XI" ${item.jenjang === 'XI' ? 'selected' : ''}>XI</option><option value="XII" ${item.jenjang === 'XII' ? 'selected' : ''}>XII</option></select>
                                        <select id="edit-kelas-${item.id}" class="w-16 p-2 bg-white border border-yellow-300 rounded text-sm"><option value="1" ${item.kelas === '1' ? 'selected' : ''}>1</option><option value="2" ${item.kelas === '2' ? 'selected' : ''}>2</option><option value="3" ${item.kelas === '3' ? 'selected' : ''}>3</option></select>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex justify-center gap-2">
                                        <button onclick="app.handlers.saveEdit(${item.id})" class="bg-green-500 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-600 transition shadow-sm">Simpan</button>
                                        <button onclick="app.handlers.cancelEdit()" class="bg-slate-400 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-500 transition shadow-sm">Batal</button>
                                    </div>
                                </td>
                            </tr>`;
                        } else {
                            return `
                            <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                                <td class="px-6 py-4 font-medium text-slate-800">${item.day}</td>
                                <td class="px-6 py-4 text-slate-600">${item.time}</td>
                                <td class="px-6 py-4 font-bold text-yellow-700">${item.subject}</td>
                                <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold border border-slate-200">${item.jenjang}-${item.kelas}</span></td>
                                <td class="px-6 py-4 text-center ${isAdmin ? '' : 'hidden'}">
                                    <div class="flex justify-center gap-2">
                                        <button onclick="app.handlers.enableEdit(${item.id})" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                        <button onclick="app.handlers.deleteSchedule(${item.id})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </td>
                            </tr>`;
                        }
                    }).join('');
                    lucide.createIcons();
                },

                renderMaterials: () => {
                    let list = app.services.materials.getAll();
                    const container = document.getElementById('material-grid');
                    const empty = document.getElementById('material-empty');
                    const isAdmin = app.state.user.role === 'admin';
                    const currentFilter = app.state.materialFilter;

                    if (currentFilter !== 'all') list = list.filter(item => item.jenjang === currentFilter);

                    if(list.length === 0) {
                        container.innerHTML = '';
                        empty.classList.remove('hidden');
                    } else {
                        empty.classList.add('hidden');
                    }

                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        if(btn.dataset.filter === currentFilter) {
                            btn.classList.remove('bg-white', 'text-slate-500', 'border-slate-200', 'hover:text-yellow-700');
                            btn.classList.add('bg-yellow-500', 'text-white', 'shadow-md', 'shadow-yellow-500/30');
                        } else {
                            btn.classList.add('bg-white', 'text-slate-500', 'border-slate-200', 'hover:text-yellow-700');
                            btn.classList.remove('bg-yellow-500', 'text-white', 'shadow-md', 'shadow-yellow-500/30');
                        }
                    });

                    container.innerHTML = list.map(item => {
                        const icon = item.type === 'video' ? 'play-circle' : item.type === 'link' ? 'link' : 'file-text';
                        const typeLabel = item.type === 'video' ? 'Video' : item.type === 'link' ? 'Tautan' : 'Dokumen';
                        const jenjangColor = item.jenjang === 'X' ? 'bg-emerald-100 text-emerald-700' : item.jenjang === 'XI' ? 'bg-sky-100 text-sky-700' : 'bg-purple-100 text-purple-700';

                        return `
                        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-lg transition-all group relative flex flex-col h-full">
                            ${isAdmin ? `<button onclick="app.handlers.deleteMaterial(${item.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition z-10"><i data-lucide="x" class="w-5 h-5"></i></button>` : ''}
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex gap-2">
                                    <span class="${jenjangColor} px-2.5 py-1 rounded-lg text-xs font-bold">Kelas ${item.jenjang}</span>
                                    <span class="bg-slate-100 text-slate-500 px-2.5 py-1 rounded-lg text-xs font-bold uppercase tracking-wide">${typeLabel}</span>
                                </div>
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="p-2.5 rounded-xl ${item.type === 'video' ? 'bg-red-50 text-red-500' : item.type === 'link' ? 'bg-blue-50 text-blue-500' : 'bg-orange-50 text-orange-500'}">
                                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800 text-lg leading-tight group-hover:text-yellow-600 transition-colors">${item.title}</h4>
                                </div>
                                <p class="text-slate-500 text-sm mb-4 leading-relaxed">${item.desc}</p>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-50 flex items-center justify-between">
                                <span class="text-xs text-slate-400 font-mono">${item.date}</span>
                                <button class="flex items-center gap-2 bg-slate-50 hover:bg-yellow-500 hover:text-white text-slate-600 font-bold py-2 px-4 rounded-lg text-sm transition-all shadow-sm">
                                    <span>${item.type === 'link' ? 'Kunjungi' : item.type === 'video' ? 'Tonton' : 'Download'}</span>
                                    <i data-lucide="${item.type === 'link' ? 'external-link' : item.type === 'video' ? 'play' : 'download'}" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                    lucide.createIcons();
                },

                renderQuizzes: () => {
                    let list = app.services.quizzes.getAll();
                    const container = document.getElementById('quiz-grid');
                    const empty = document.getElementById('quiz-empty');
                    const isAdmin = app.state.user.role === 'admin';
                    const currentFilter = app.state.quizFilter;

                    if (currentFilter !== 'all') list = list.filter(item => item.jenjang === currentFilter);

                    if(list.length === 0) {
                        container.innerHTML = '';
                        empty.classList.remove('hidden');
                    } else {
                        empty.classList.add('hidden');
                    }

                    document.querySelectorAll('.quiz-filter-btn').forEach(btn => {
                        if(btn.dataset.filter === currentFilter) {
                            btn.classList.remove('bg-white', 'text-slate-500', 'border-slate-200', 'hover:text-yellow-700');
                            btn.classList.add('bg-yellow-500', 'text-white', 'shadow-md', 'shadow-yellow-500/30');
                        } else {
                            btn.classList.add('bg-white', 'text-slate-500', 'border-slate-200', 'hover:text-yellow-700');
                            btn.classList.remove('bg-yellow-500', 'text-white', 'shadow-md', 'shadow-yellow-500/30');
                        }
                    });

                    container.innerHTML = list.map(item => {
                        const typeLabel = item.type === 'pg' ? 'Pilihan Ganda' : item.type === 'short' ? 'Jawaban Singkat' : 'Uraian';
                        const typeColor = item.type === 'pg' ? 'bg-indigo-100 text-indigo-700' : item.type === 'short' ? 'bg-pink-100 text-pink-700' : 'bg-teal-100 text-teal-700';
                        const jenjangColor = item.jenjang === 'X' ? 'bg-emerald-100 text-emerald-700' : item.jenjang === 'XI' ? 'bg-sky-100 text-sky-700' : 'bg-purple-100 text-purple-700';

                        return `
                        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-lg transition-all relative flex flex-col h-full">
                            ${isAdmin ? `<button onclick="app.handlers.deleteQuiz(${item.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                            
                            <div class="flex gap-2 mb-4">
                                <span class="${jenjangColor} px-2.5 py-1 rounded-lg text-xs font-bold">Kelas ${item.jenjang}</span>
                                <span class="${typeColor} px-2.5 py-1 rounded-lg text-xs font-bold">${typeLabel}</span>
                            </div>

                            <div class="flex-grow">
                                <h4 class="font-bold text-slate-800 text-lg mb-2">${item.title}</h4>
                                <div class="flex items-center gap-4 text-xs text-slate-500 font-medium">
                                    <span class="flex items-center gap-1"><i data-lucide="help-circle" class="w-3 h-3"></i> ${item.questions.length} Soal</span>
                                    <span class="flex items-center gap-1"><i data-lucide="star" class="w-3 h-3"></i> Total Skor: ${item.totalScore}</span>
                                </div>
                            </div>

                            <div class="mt-6 pt-4 border-t border-slate-50 space-y-2">
                                <button onclick="app.handlers.startQuiz(${item.id})" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2.5 rounded-xl text-sm transition flex items-center justify-center gap-2">
                                    <i data-lucide="pen-tool" class="w-4 h-4"></i> Kerjakan / Simulasi
                                </button>
                                ${isAdmin ? `
                                <button onclick="app.handlers.exportQuizRecap(${item.id})" class="w-full bg-green-50 text-green-700 hover:bg-green-100 font-bold py-2.5 rounded-xl text-sm transition flex items-center justify-center gap-2 border border-green-200">
                                    <i data-lucide="download" class="w-4 h-4"></i> Download Rekap Nilai
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                },

                renderStudentsDB: () => {
                    const students = app.services.students.getAll();
                    const tbody = document.getElementById('student-db-list');
                    document.getElementById('student-count').textContent = students.length + " Siswa";

                    if(students.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400">Belum ada data siswa.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = students.map(s => `
                        <tr class="hover:bg-slate-50 border-b border-slate-50">
                            <td class="px-4 py-3 font-medium text-slate-700">${s.name}</td>
                            <td class="px-4 py-3 text-slate-500">${s.jenjang}-${s.angka}</td>
                            <td class="px-4 py-3 text-blue-600 font-mono text-xs">${s.username}</td>
                            <td class="px-4 py-3 text-slate-400 font-mono text-xs">******</td>
                        </tr>
                    `).join('');
                }
            },

            // --- STATE & HANDLERS ---
            state: {
                user: null,
                editingId: null,
                materialFilter: 'all',
                quizFilter: 'all',
                tempQuizData: {} // For multi-step form
            },

            handlers: {
                init: () => {
                    const session = sessionStorage.getItem('user_session');
                    if(session) {
                        app.state.user = JSON.parse(session);
                        app.handlers.enterDashboard();
                    } else {
                        document.getElementById('absen-date').valueAsDate = new Date();
                    }
                    lucide.createIcons();
                },

                handleLogin: (e) => {
                    e.preventDefault();
                    const u = document.getElementById('login-user').value.trim();
                    const p = document.getElementById('login-pass').value.trim();
                    const alert = document.getElementById('login-alert');

                    if(u === 'admin' && p === 'admin123') {
                        // Calculate years since 2009 automatically
                        const startYear = 2009;
                        const currentYear = new Date().getFullYear();
                        const expYears = (currentYear - startYear) + " Tahun";

                        app.state.user = { 
                            role: 'admin', 
                            name: 'Krislina, M.Pd.', 
                            mapel: 'Kimia',
                            desc: 'Guru Kimia',
                            bio: 'Guru Kimia berpengalaman dengan dedikasi tinggi dalam menciptakan pembelajaran yang interaktif dan menyenangkan. Berfokus pada pengembangan pemahaman konseptual dan aplikasi praktis ilmu kimia dalam kehidupan sehari-hari.',
                            edu: 'S2 Pendidikan Ilmu Pengetahuan Alam',
                            exp: expYears,
                            email: 'krislina121@gmail.com',
                            phone: '081216660646',
                            photo: null // Default photo state
                        };
                        sessionStorage.setItem('user_session', JSON.stringify(app.state.user));
                        app.handlers.enterDashboard();
                        return;
                    }
                    
                    if(u === 'siswa' && p === 'siswa123') {
                        app.state.user = { role: 'student', name: 'Siswa Demo', desc: 'Kelas X-1', jenjang: 'X', kelas: '1' };
                        sessionStorage.setItem('user_session', JSON.stringify(app.state.user));
                        app.handlers.enterDashboard();
                        return;
                    }

                    const student = app.services.students.auth(u, p);
                    if(student) {
                        app.state.user = { role: 'student', name: student.name, desc: `Kelas ${student.jenjang}-${student.angka}`, data: student };
                        sessionStorage.setItem('user_session', JSON.stringify(app.state.user));
                        app.handlers.enterDashboard();
                        return;
                    }

                    alert.classList.remove('hidden');
                    setTimeout(() => alert.classList.add('hidden'), 2000);
                },

                enterDashboard: () => {
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    document.getElementById('view-dashboard').classList.add('flex');

                    const u = app.state.user;
                    // For admin, use saved profile name if edited, else default login name
                    const storedProfile = app.services.storage.get('admin_profile', null);
                    const displayName = (u.role === 'admin' && storedProfile) ? storedProfile.name : u.name;

                    document.getElementById('nav-user-name').textContent = displayName;
                    document.getElementById('nav-user-role').textContent = u.role === 'admin' ? 'Guru' : 'Siswa';
                    
                    app.ui.renderMenu(u.role);
                    
                    document.querySelectorAll('.admin-only').forEach(el => {
                        if(u.role === 'admin') el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    });

                    app.ui.renderProfile(u);
                    app.handlers.nav('profil');
                    app.ui.renderStudentsDB();
                    app.ui.renderSchedule();
                    app.ui.renderMaterials();
                    app.ui.renderQuizzes();
                },

                logout: () => {
                    app.state.user = null;
                    sessionStorage.removeItem('user_session');
                    location.reload();
                },

                nav: (pageId) => {
                    document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById('page-' + pageId).classList.remove('hidden');
                    
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('bg-yellow-50', 'text-yellow-700', 'font-bold');
                        el.classList.add('text-slate-500');
                    });
                    const btn = document.getElementById('btn-' + pageId);
                    if(btn) {
                        btn.classList.add('bg-yellow-50', 'text-yellow-700', 'font-bold');
                        btn.classList.remove('text-slate-500');
                    }
                    
                    if(pageId === 'datasiswa') app.ui.renderStudentsDB();
                    if(pageId === 'jadwal') app.ui.renderSchedule();
                    if(pageId === 'materi') app.ui.renderMaterials();
                    if(pageId === 'ujian') app.ui.renderQuizzes();
                },

                // --- PROFILE EDIT HANDLERS (NEW) ---
                openEditProfile: () => {
                    const storedUser = app.services.storage.get('admin_profile', app.state.user);
                    
                    document.getElementById('edit-name').value = storedUser.name || '';
                    document.getElementById('edit-bio').value = storedUser.bio || '';
                    document.getElementById('edit-email').value = storedUser.email || '';
                    document.getElementById('edit-phone').value = storedUser.phone || '';
                    document.getElementById('edit-edu').value = storedUser.edu || '';
                    document.getElementById('edit-mapel').value = storedUser.mapel || '';
                    
                    // Show current photo preview if exists
                    const preview = document.getElementById('preview-avatar');
                    if(storedUser.photo) {
                        preview.innerHTML = `<img src="${storedUser.photo}" class="w-full h-full object-cover">`;
                    } else {
                        preview.innerHTML = '<i data-lucide="user" class="w-8 h-8 text-slate-300"></i>';
                        lucide.createIcons();
                    }

                    app.ui.modals.openEditProfile();
                },

                previewImage: (input) => {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        
                        // Limit file size check (e.g. 2MB) just in case
                        if (file.size > 2 * 1024 * 1024) {
                            alert("Ukuran file terlalu besar! Maksimal 2MB.");
                            input.value = ""; // clear input
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = new Image();
                            img.onload = function() {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Resize to max 300x300
                                const maxSize = 300;
                                let width = img.width;
                                let height = img.height;
                                
                                if (width > height) {
                                    if (width > maxSize) {
                                        height *= maxSize / width;
                                        width = maxSize;
                                    }
                                } else {
                                    if (height > maxSize) {
                                        width *= maxSize / height;
                                        height = maxSize;
                                    }
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // Compress to JPEG 0.7
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                                
                                const preview = document.getElementById('preview-avatar');
                                preview.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
                                
                                // Store this dataUrl in a temporary state to be saved later
                                app.state.tempPhoto = dataUrl;
                            };
                            img.src = e.target.result;
                        }
                        reader.readAsDataURL(file);
                    }
                },

                saveProfile: (e) => {
                    e.preventDefault();
                    const form = new FormData(e.target);
                    
                    // Base profile object
                    const updatedProfile = {
                        name: form.get('name'),
                        bio: form.get('bio'),
                        email: form.get('email'),
                        phone: form.get('phone'),
                        edu: form.get('edu'),
                        mapel: form.get('mapel'),
                        desc: 'Guru Kimia' // Keep default desc or make editable if needed
                    };

                    // Check if a new photo was processed in previewImage
                    if (app.state.tempPhoto) {
                        updatedProfile.photo = app.state.tempPhoto;
                        app.handlers.finalizeProfileSave(updatedProfile);
                        // Clear temp
                        app.state.tempPhoto = null;
                    } else {
                        // Keep existing photo if not changed
                        const existing = app.services.storage.get('admin_profile', {});
                        if(existing.photo) updatedProfile.photo = existing.photo;
                        app.handlers.finalizeProfileSave(updatedProfile);
                    }
                },

                finalizeProfileSave: (profileData) => {
                    // Save to persistent storage
                    app.services.storage.set('admin_profile', profileData);
                    
                    // Update current session state
                    app.state.user = { ...app.state.user, ...profileData };
                    
                    app.ui.modals.closeAll();
                    app.ui.renderProfile(app.state.user);
                    app.ui.toast("Profil berhasil diperbarui!", "success");
                    
                    // Update header name
                    document.getElementById('nav-user-name').textContent = profileData.name;
                },

                handleImport: () => {
                    const raw = document.getElementById('import-names').value;
                    if(!raw.trim()) return app.ui.toast("Data nama kosong!", "error");

                    const jenjang = document.getElementById('import-jenjang').value;
                    const angka = document.getElementById('import-angka').value;
                    const lines = raw.split('\n').filter(l => l.trim() !== '');

                    const newStudents = lines.map(name => {
                        const cleanName = name.trim();
                        const user = cleanName.split(' ')[0].toLowerCase() + Math.floor(Math.random()*90 + 10);
                        return {
                            id: Date.now() + Math.random(),
                            name: cleanName,
                            jenjang: jenjang,
                            angka: angka,
                            username: user,
                            password: user + '123'
                        };
                    });

                    app.services.students.addBatch(newStudents);
                    app.ui.renderStudentsDB();
                    document.getElementById('import-names').value = '';
                    app.ui.toast(`Berhasil import ${newStudents.length} siswa!`, "success");
                },

                saveSchedule: (e) => {
                    e.preventDefault();
                    const form = new FormData(e.target);
                    const obj = Object.fromEntries(form.entries());
                    app.services.schedule.add(obj);
                    app.ui.renderSchedule();
                    app.ui.modals.closeAll();
                    e.target.reset();
                    app.ui.toast("Jadwal disimpan", "success");
                },
                deleteSchedule: (id) => {
                    if(confirm("Hapus jadwal ini secara permanen?")) {
                        app.services.schedule.delete(id);
                        app.ui.renderSchedule();
                        app.ui.toast("Jadwal dihapus", "info");
                    }
                },
                enableEdit: (id) => {
                    app.state.editingId = id;
                    app.ui.renderSchedule();
                },
                cancelEdit: () => {
                    app.state.editingId = null;
                    app.ui.renderSchedule();
                },
                saveEdit: (id) => {
                    const updatedData = {
                        day: document.getElementById(`edit-day-${id}`).value,
                        time: document.getElementById(`edit-time-${id}`).value,
                        subject: document.getElementById(`edit-subject-${id}`).value,
                        jenjang: document.getElementById(`edit-jenjang-${id}`).value,
                        kelas: document.getElementById(`edit-kelas-${id}`).value
                    };
                    app.services.schedule.update(id, updatedData);
                    app.state.editingId = null;
                    app.ui.renderSchedule();
                    app.ui.toast("Perubahan jadwal disimpan", "success");
                },

                saveMaterial: (e) => {
                    e.preventDefault();
                    const form = new FormData(e.target);
                    const obj = Object.fromEntries(form.entries());
                    app.services.materials.add(obj);
                    app.ui.renderMaterials();
                    app.ui.modals.closeAll();
                    e.target.reset();
                    app.ui.toast("Materi ditambahkan", "success");
                },
                deleteMaterial: (id) => {
                    if(confirm("Hapus materi ini?")) {
                        app.services.materials.delete(id);
                        app.ui.renderMaterials();
                    }
                },
                filterMaterials: (filter) => {
                    app.state.materialFilter = filter;
                    app.ui.renderMaterials();
                },

                // --- NEW QUIZ HANDLERS (2-STEP WIZARD) ---
                setupQuizForm: (e) => {
                    e.preventDefault();
                    const title = document.getElementById('new-quiz-title').value;
                    const jenjang = document.getElementById('new-quiz-jenjang').value;
                    const type = document.getElementById('new-quiz-type').value;
                    const count = parseInt(document.getElementById('new-quiz-count').value);

                    app.state.tempQuizData = { title, jenjang, count, type };

                    // Generate Step 2 Form
                    const container = document.getElementById('questions-container');
                    const typeLabel = type === 'pg' ? 'Pilihan Ganda (Pilih kunci jawaban radio button)' : 'Isi kunci jawaban (Sistem akan mencocokkan teks)';
                    
                    document.getElementById('quiz-question-subtitle').textContent = `Membuat ${count} soal untuk ${title} (Kelas ${jenjang})`;
                    document.getElementById('quiz-question-hint').textContent = typeLabel;
                    
                    let html = '';
                    for(let i = 0; i < count; i++) {
                        if (type === 'pg') {
                            html += `
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4 shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-slate-700">Soal No. ${i+1}</h4>
                                    <input type="number" name="score_${i}" placeholder="Bobot Skor" class="w-24 p-1.5 border rounded text-xs text-center focus:border-yellow-400" required>
                                </div>
                                <textarea name="q_text_${i}" placeholder="Tulis pertanyaan disini..." rows="2" class="w-full p-3 border rounded-lg text-sm mb-3 focus:border-yellow-400" required></textarea>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pl-2">
                                    ${['A','B','C','D','E'].map((opt, idx) => `
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="ans_${i}" value="${idx}" class="cursor-pointer" required title="Pilih sebagai kunci jawaban">
                                            <span class="font-bold text-slate-400 text-xs">${opt}.</span>
                                            <input type="text" name="opt_${i}_${idx}" placeholder="Pilihan ${opt}" class="flex-grow p-2 border rounded text-sm focus:border-yellow-400" required>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            `;
                        } else {
                            // Short answer AND Essay use the same logic for setting key (string match)
                            // But presentation for student will differ
                            html += `
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4 shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-slate-700">Soal No. ${i+1}</h4>
                                    <input type="number" name="score_${i}" placeholder="Bobot Skor" class="w-24 p-1.5 border rounded text-xs text-center focus:border-yellow-400" required>
                                </div>
                                <textarea name="q_text_${i}" placeholder="Tulis pertanyaan disini..." rows="2" class="w-full p-3 border rounded-lg text-sm mb-3 focus:border-yellow-400" required></textarea>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Kunci Jawaban (Sistem akan mencocokkan teks ini)</label>
                                    <textarea name="ans_text_${i}" placeholder="Masukkan jawaban benar..." rows="2" class="w-full p-2 border rounded text-sm focus:border-yellow-400 font-medium" required></textarea>
                                </div>
                            </div>
                            `;
                        }
                    }
                    container.innerHTML = html;

                    // Switch Modals
                    document.getElementById('modal-quiz-create').classList.add('hidden');
                    document.getElementById('modal-quiz-questions').classList.remove('hidden');
                },

                saveFullQuiz: (e) => {
                    e.preventDefault();
                    const form = new FormData(e.target);
                    const count = app.state.tempQuizData.count;
                    const type = app.state.tempQuizData.type;
                    const questions = [];
                    let totalScore = 0;

                    for(let i = 0; i < count; i++) {
                        const score = parseInt(form.get(`score_${i}`)) || 0;
                        totalScore += score;
                        
                        let q = {
                            text: form.get(`q_text_${i}`),
                            score: score
                        };

                        if (type === 'pg') {
                            q.correct = parseInt(form.get(`ans_${i}`));
                            q.options = [
                                form.get(`opt_${i}_0`),
                                form.get(`opt_${i}_1`),
                                form.get(`opt_${i}_2`),
                                form.get(`opt_${i}_3`),
                                form.get(`opt_${i}_4`)
                            ];
                        } else {
                            q.correct = form.get(`ans_text_${i}`);
                        }
                        
                        questions.push(q);
                    }

                    const finalQuiz = {
                        title: app.state.tempQuizData.title,
                        jenjang: app.state.tempQuizData.jenjang,
                        type: type, 
                        questions: questions,
                        totalScore: totalScore
                    };

                    app.services.quizzes.add(finalQuiz);
                    app.ui.renderQuizzes();
                    app.ui.modals.closeAll();
                    e.target.reset(); // Reset step 2 form
                    document.getElementById('new-quiz-title').value = ''; // Reset step 1 inputs
                    document.getElementById('new-quiz-count').value = '';
                    
                    app.ui.toast("Kuis berhasil dibuat!", "success");
                },

                deleteQuiz: (id) => {
                    if(confirm("Hapus kuis ini beserta seluruh data nilainya?")) {
                        app.services.quizzes.delete(id);
                        app.ui.renderQuizzes();
                        app.ui.toast("Kuis dihapus", "info");
                    }
                },
                filterQuizzes: (filter) => {
                    app.state.quizFilter = filter;
                    app.ui.renderQuizzes();
                },
                startQuiz: (id) => {
                    const quiz = app.services.quizzes.getAll().find(q => q.id === id);
                    if(quiz) {
                        app.ui.modals.openQuizRun(quiz);
                    }
                },
                
                // --- NEW: SUBMIT QUIZ & CALCULATE SCORE ---
                submitQuiz: (quizId) => {
                    const quiz = app.services.quizzes.getAll().find(q => q.id === quizId);
                    if(!quiz) return;

                    const form = document.getElementById('run-quiz-form');
                    const formData = new FormData(form);
                    
                    let earnedScore = 0;
                    let correctCount = 0;
                    
                    // Evaluate answers
                    quiz.questions.forEach((q, i) => {
                        const selected = formData.get(`q_${i}`);
                        const uploadedFile = document.querySelector(`input[name="q_file_${i}"]`)?.files[0];
                        
                        if (quiz.type === 'pg') {
                            if(selected !== null && parseInt(selected) === q.correct) {
                                earnedScore += q.score;
                                correctCount++;
                            }
                        } else {
                            // Check text match (insensitive)
                            if(selected && selected.trim().toLowerCase() === q.correct.trim().toLowerCase()) {
                                earnedScore += q.score;
                                correctCount++;
                            }
                            // Note: We don't auto-grade files in this simulation
                        }
                    });

                    // Save Result
                    const studentName = app.state.user.name;
                    const studentId = app.state.user.username || 'guest';
                    const result = {
                        student: studentName,
                        studentId: studentId,
                        score: earnedScore,
                        total: quiz.totalScore,
                        date: new Date().toLocaleDateString('id-ID')
                    };
                    
                    app.services.quizzes.saveResult(quizId, result);
                    
                    app.ui.modals.closeAll();
                    alert(`Kuis Selesai!\n\nSkor Anda: ${earnedScore} / ${quiz.totalScore}\nJawaban Benar: ${correctCount} dari ${quiz.questions.length} soal.\n(Jawaban file akan diperiksa manual oleh guru)`);
                },

                // --- NEW: EXPORT QUIZ SCORES ---
                exportQuizRecap: (quizId) => {
                    const quiz = app.services.quizzes.getAll().find(q => q.id === quizId);
                    if(!quiz || !quiz.results || quiz.results.length === 0) {
                        return app.ui.toast("Belum ada data nilai siswa.", "error");
                    }

                    let csv = "No,Nama Siswa,ID Siswa,Nilai Perolehan,Total Skor Maksimal,Tanggal\n";
                    quiz.results.forEach((r, i) => {
                        csv += `${i+1},${r.student},${r.studentId},${r.score},${r.total},${r.date}\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', `Rekap_Nilai_${quiz.title.replace(/\s+/g, '_')}.csv`);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    app.ui.toast("Rekap nilai berhasil diunduh!", "success");
                },

                // Absensi
                loadAttendance: () => {
                    const jenjang = document.getElementById('absen-jenjang').value;
                    const kelas = document.getElementById('absen-kelas').value;
                    const date = document.getElementById('absen-date').value;
                    const list = document.getElementById('attendance-list');
                    const placeholder = document.getElementById('attendance-placeholder');

                    if(!date) return;

                    const students = app.services.students.getAll().filter(s => s.jenjang === jenjang && s.angka === kelas);
                    
                    if(students.length === 0) {
                        list.innerHTML = '';
                        placeholder.classList.remove('hidden');
                        placeholder.textContent = "Tidak ada siswa di kelas ini.";
                        return;
                    }
                    placeholder.classList.add('hidden');

                    const record = app.services.attendance.get(date, jenjang, kelas);
                    const isAdmin = app.state.user.role === 'admin';

                    list.innerHTML = students.map(s => {
                        const status = record[s.id];
                        const statusColor = status === 'Hadir' ? 'bg-green-100 text-green-700 border-green-200' 
                            : status === 'Sakit' ? 'bg-yellow-100 text-yellow-700 border-yellow-200'
                            : status === 'Izin' ? 'bg-blue-100 text-blue-700 border-blue-200'
                            : status === 'Alpa' ? 'bg-red-100 text-red-700 border-red-200'
                            : 'bg-slate-50 text-slate-400 border-slate-100';

                        let actions = '';
                        if(isAdmin) {
                            actions = `
                                <div class="flex gap-1">
                                    <button onclick="app.handlers.markAttendance('${s.id}', 'Hadir')" class="px-3 py-1 text-xs font-bold rounded hover:bg-green-200 ${status==='Hadir'?'bg-green-500 text-white': 'bg-slate-100 text-slate-500'}">H</button>
                                    <button onclick="app.handlers.markAttendance('${s.id}', 'Sakit')" class="px-3 py-1 text-xs font-bold rounded hover:bg-yellow-200 ${status==='Sakit'?'bg-yellow-500 text-white': 'bg-slate-100 text-slate-500'}">S</button>
                                    <button onclick="app.handlers.markAttendance('${s.id}', 'Izin')" class="px-3 py-1 text-xs font-bold rounded hover:bg-blue-200 ${status==='Izin'?'bg-blue-500 text-white': 'bg-slate-100 text-slate-500'}">I</button>
                                    <button onclick="app.handlers.markAttendance('${s.id}', 'Alpa')" class="px-3 py-1 text-xs font-bold rounded hover:bg-red-200 ${status==='Alpa'?'bg-red-500 text-white': 'bg-slate-100 text-slate-500'}">A</button>
                                </div>
                            `;
                        } else {
                            actions = `<span class="px-3 py-1 rounded text-xs font-bold border ${statusColor}">${status || 'Belum Absen'}</span>`;
                        }

                        return `
                        <div class="flex items-center justify-between p-3 bg-white border rounded-lg hover:shadow-sm transition">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 text-xs">${s.name.charAt(0)}</div>
                                <div>
                                    <p class="font-bold text-sm text-slate-700">${s.name}</p>
                                    <p class="text-xs text-slate-400">ID: ${s.username}</p>
                                </div>
                            </div>
                            ${actions}
                        </div>
                        `;
                    }).join('');
                },

                markAttendance: (studentId, status) => {
                    const jenjang = document.getElementById('absen-jenjang').value;
                    const kelas = document.getElementById('absen-kelas').value;
                    const date = document.getElementById('absen-date').value;
                    const record = app.services.attendance.get(date, jenjang, kelas);
                    record[studentId] = status;
                    app.services.attendance.save(date, jenjang, kelas, record);
                    app.handlers.loadAttendance();
                },

                exportAttendance: () => {
                    const jenjang = document.getElementById('absen-jenjang').value;
                    const kelas = document.getElementById('absen-kelas').value;
                    const date = document.getElementById('absen-date').value;
                    if(!date) return app.ui.toast("Pilih tanggal!", "error");
                    const students = app.services.students.getAll().filter(s => s.jenjang === jenjang && s.angka === kelas);
                    const record = app.services.attendance.get(date, jenjang, kelas);
                    let csv = "No,Nama,Status,Tanggal\n";
                    students.forEach((s, i) => {
                        csv += `${i+1},${s.name},${record[s.id] || '-'},${date}\n`;
                    });
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', `Absen_${jenjang}-${kelas}_${date}.csv`);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    app.ui.toast("Data berhasil diunduh", "success");
                },

                exportAttendanceSemester: () => {
                    const jenjang = document.getElementById('absen-jenjang').value;
                    const kelas = document.getElementById('absen-kelas').value;
                    const students = app.services.students.getAll().filter(s => s.jenjang === jenjang && s.angka === kelas);
                    const allDates = app.services.attendance.getDates(jenjang, kelas);
                    if (allDates.length === 0) return app.ui.toast("Belum ada data absensi semester ini.", "error");
                    let header1 = "No,Nama,Tanggal";
                    for(let i=0; i < allDates.length - 1; i++) header1 += ","; 
                    header1 += ",Rekap Kehadiran,,\n";
                    let header2 = ",,";
                    allDates.forEach(d => header2 += `${d},`);
                    header2 += "Sakit,Ijin,Alpa\n";
                    let rows = "";
                    students.forEach((s, i) => {
                        let row = `${i+1},${s.name},`;
                        let countS = 0, countI = 0, countA = 0;
                        allDates.forEach(date => {
                            const dailyRecord = app.services.attendance.get(date, jenjang, kelas);
                            const status = dailyRecord[s.id];
                            let shortStatus = '';
                            if (status === 'Hadir') shortStatus = 'H';
                            else if (status === 'Sakit') { shortStatus = 'S'; countS++; }
                            else if (status === 'Izin') { shortStatus = 'I'; countI++; }
                            else if (status === 'Alpa') { shortStatus = 'A'; countA++; }
                            row += `${shortStatus},`;
                        });
                        row += `${countS},${countI},${countA}\n`;
                        rows += row;
                    });
                    const csvContent = header1 + header2 + rows;
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', `Rekap_Semester_${jenjang}-${kelas}.csv`);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    app.ui.toast("Rekap semester berhasil diunduh!", "success");
                },

                resetSemester: () => {
                    const jenjang = document.getElementById('absen-jenjang').value;
                    const kelas = document.getElementById('absen-kelas').value;
                    if(confirm(`PERINGATAN: Anda akan menghapus SELURUH data absensi semester ini untuk kelas ${jenjang}-${kelas}.\n\nTindakan ini diperlukan untuk persiapan rapor semester baru, namun data lama akan hilang permanen.\n\nLanjutkan reset?`)) {
                        const count = app.services.attendance.reset(jenjang, kelas);
                        app.handlers.loadAttendance();
                        app.ui.toast(`Reset berhasil. ${count} data hari dihapus.`, "success");
                    }
                }
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', app.handlers.init);

    </script>
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD8gBrAUI2sCh74u-C4LU8JWqrF95iadpE",
    authDomain: "kelas-digital-kimia.firebaseapp.com",
    projectId: "kelas-digital-kimia",
    storageBucket: "kelas-digital-kimia.firebasestorage.app",
    messagingSenderId: "85696838190",
    appId: "1:85696838190:web:9af863cf55d3c153f8bdbf"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
</body>
</html>

